<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Online Examination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Disable text selection throughout the page */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }
        .guidelines ul {
            list-style-position: inside;
            text-align: left;
            margin-left: 1.5rem;
        }
        .guidelines ul li {
            margin-bottom: 0.75rem;
        }
        .question-palette-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .not-answered { background-color: #e5e7eb; color: #374151; }
        .answered { background-color: #10b981; color: white; }
        .marked-for-review { background-color: #6366f1; color: white; }
        .current-question { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        textarea:focus {
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
             border-color: #3b82f6;
             outline: none;
        }
        /* Allow text selection only in textareas */
        textarea {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
        /* Hide content when printing */
        @media print {
          body {
            visibility: hidden;
          }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">

    <div id="container" class="w-full max-w-6xl mx-auto p-4 md:p-8">

        <!-- 0. Login Screen -->
        <div id="login-screen" class="p-8 bg-white rounded-2xl shadow-xl text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Welcome to the Examination Portal</h1>
            <p class="text-gray-600 mb-8">Please select your name to begin the exam.</p>
            <div class="flex justify-center gap-8">
                <button data-student="siril" class="student-login-btn bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                    I am Siril (Class 9)
                </button>
                <button data-student="sam" class="student-login-btn bg-green-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                    I am Sam (Class 10)
                </button>
            </div>
        </div>
        
        <!-- ADMIN: Login Screen -->
        <div id="admin-login-screen" class="hidden p-8 bg-white rounded-2xl shadow-xl text-center max-w-md mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Admin Access</h1>
            <p class="text-gray-600 mb-6">Enter password to manage exam questions.</p>
            <input type="password" id="admin-password" class="w-full p-3 border border-gray-300 rounded-lg mb-4" placeholder="Password">
            <button id="admin-login-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-black">Login</button>
            <p id="admin-login-error" class="text-red-500 mt-4 hidden">Incorrect password.</p>
        </div>

        <!-- ADMIN: Panel -->
        <div id="admin-panel-screen" class="hidden p-8 bg-white rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel: Question Management</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-semibold mb-2">Class 9 (Science) Questions</h2>
                    <p class="text-sm text-gray-500 mb-2">Enter one question per line.</p>
                    <textarea id="admin-questions-class9" rows="10" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Explain the process of photosynthesis in plants."></textarea>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-2">Class 10 (Mathematics) Questions</h2>
                    <p class="text-sm text-gray-500 mb-2">Enter one question per line.</p>
                    <textarea id="admin-questions-class10" rows="10" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Solve the quadratic equation: x² - 5x + 6 = 0."></textarea>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="admin-save-btn" class="bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700">Save Questions</button>
                <p id="admin-save-feedback" class="text-green-600 mt-4 font-semibold"></p>
            </div>
        </div>

        <!-- 1. Guidelines Screen -->
        <div id="guidelines-screen" class="hidden p-8 bg-white rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">Before Exam Guidelines</h1>
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">(Must Read & Accept)</h2>
            <div class="guidelines text-gray-600 max-h-96 overflow-y-auto pr-4">
                <ul class="list-disc space-y-3">
                    <li>This exam will enter full-screen mode automatically.</li>
                    <li>You must turn on your camera and microphone throughout the exam.</li>
                    <li>You must be alone in the room — no other person should be visible or heard.</li>
                    <li>Your face and hands must remain visible on camera at all times.</li>
                    <li>No mobile phones, smartwatches, or books are allowed near your desk.</li>
                    <li>You may not open any other tab, application, or window during the exam.</li>
                    <li>If you switch tabs, minimize the screen, or your camera is off, your exam may be auto-terminated.</li>
                    <li>Any suspicious activity (background voice, second face, etc.) will result in disqualification.</li>
                </ul>
                <p class="font-bold mt-6">By clicking “I Agree”, you give consent for:</p>
                <ul class="list-disc mt-2">
                    <li>Camera and microphone access</li>
                    <li>Live monitoring and recording</li>
                    <li>Data being used for exam verification purposes only</li>
                </ul>
            </div>
            <div class="mt-8 pt-6 border-t flex flex-col items-center">
                <label class="flex items-center text-lg">
                    <input type="checkbox" id="agree-checkbox" class="h-5 w-5 mr-3 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    I have read and agree to follow all the above guidelines.
                </label>
                <button id="agree-btn" class="mt-6 bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Submit & Agree
                </button>
            </div>
        </div>


        <!-- 2. Permissions Screen -->
        <div id="permissions-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">System Check</h1>
            <p class="text-gray-600 mb-6">This exam requires camera and microphone access for proctoring.</p>
            <p class="text-sm text-gray-500 mb-8">Please grant permissions to continue.</p>
            <button id="grant-permissions-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                Grant Access
            </button>
            <p id="permissions-error" class="text-red-500 mt-4 hidden"></p>
        </div>

        <!-- 3. ID Verification Screen -->
        <div id="id-verification-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Identity Verification</h2>
            <p class="text-gray-600 mb-6">Please hold your government-issued photo ID clearly in front of the camera.</p>
            <div class="relative w-full max-w-lg mx-auto mb-6 rounded-lg overflow-hidden shadow-inner border">
                <video id="webcam-preview" autoplay playsinline muted class="w-full h-auto"></video>
                <canvas id="id-canvas" class="hidden"></canvas>
            </div>
            <button id="capture-id-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                Capture ID
            </button>
            <div id="id-capture-feedback" class="mt-4"></div>
        </div>
        
        <!-- 3.5 Pre-Exam Lobby Screen -->
        <div id="pre-exam-lobby-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Final Step Before Starting</h2>
            <p class="text-gray-600 mb-6">A new window has opened for the Google Meet proctoring session. Please join the meeting now.</p>
            <p class="text-gray-600 mb-8 font-semibold">Once you have successfully joined the meeting, click the button below to start your exam.</p>
            <button id="start-exam-now-btn" class="bg-green-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-green-700 transition-colors shadow-lg animate-pulse">
                I have joined the meeting, Start Exam
            </button>
            <p class="text-sm text-gray-500 mt-6">Do not close the Google Meet window during the exam.</p>
        </div>

        <!-- 4. Exam Screen -->
        <div id="exam-screen" class="hidden p-4 sm:p-6 md:p-8 bg-white rounded-2xl shadow-xl">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b">
                <div id="exam-header-info">
                    <!-- Student-specific info will be injected here -->
                </div>
                <div id="timer" class="mt-4 sm:mt-0 text-2xl font-bold text-red-600 bg-red-100 px-4 py-2 rounded-lg">60:00</div>
            </header>
            
            <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <div id="question-container" class="bg-gray-50 p-6 rounded-lg">
                        <!-- Question content will be dynamically inserted here -->
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="prev-question-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Previous</button>
                        <button id="mark-review-btn" class="bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600">Mark for Review</button>
                        <button id="next-question-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next</button>
                    </div>
                </div>

                <aside class="lg:col-span-1">
                    <div class="bg-gray-800 p-4 rounded-lg text-white mb-6">
                        <h4 class="font-semibold mb-2 text-center">Proctoring Active</h4>
                        <div class="relative w-full aspect-w-4 aspect-h-3 rounded-md overflow-hidden bg-black">
                            <video id="proctor-feed" autoplay playsinline muted class="w-full h-full object-cover"></video>
                        </div>
                        <p class="text-xs text-center mt-2 text-gray-400">Your webcam and microphone are being recorded.</p>
                         <div class="mt-2 text-center">
                            <p class="text-sm font-semibold text-yellow-400">Violations: <span id="violation-counter">0</span> / 5</p>
                        </div>
                    </div>
                     <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-3 text-center text-gray-700">Question Palette</h4>
                        <div id="question-palette" class="grid grid-cols-5 gap-2">
                            <!-- Palette buttons will be dynamically inserted here -->
                        </div>
                    </div>
                    <button id="submit-exam-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                        Submit Exam
                    </button>
                </aside>
            </main>
        </div>

        <!-- Blocking overlay for violations -->
        <div id="violation-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" data-violation-type="">
            <div class="text-center text-white p-12 rounded-lg">
                <h2 class="text-4xl font-bold text-yellow-400 mb-4">Warning!</h2>
                <p id="violation-message" class="text-xl mb-2"></p>
                <p class="text-lg">Please resolve the issue immediately.</p>
                <p id="violation-count-message" class="mt-6 text-2xl font-bold text-red-500"></p>
            </div>
        </div>
        
        <!-- Screenshot Blackout Overlay -->
        <div id="screenshot-overlay" class="hidden fixed inset-0 bg-black flex items-center justify-center z-[100]">
            <h2 class="text-4xl font-bold text-white">Screenshots are not permitted.</h2>
        </div>

        <!-- Custom Confirmation Modal for Submission -->
        <div id="confirm-submit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Submission</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to submit the exam?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-submit-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-8 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="confirm-submit-btn" class="bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-700">Yes, Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const guidelinesScreen = document.getElementById('guidelines-screen');
        const agreeCheckbox = document.getElementById('agree-checkbox');
        const agreeBtn = document.getElementById('agree-btn');
        const permissionsScreen = document.getElementById('permissions-screen');
        const idVerificationScreen = document.getElementById('id-verification-screen');
        const preExamLobbyScreen = document.getElementById('pre-exam-lobby-screen');
        const examScreen = document.getElementById('exam-screen');
        const grantPermissionsBtn = document.getElementById('grant-permissions-btn');
        const permissionsError = document.getElementById('permissions-error');
        const webcamPreview = document.getElementById('webcam-preview');
        const proctorFeed = document.getElementById('proctor-feed');
        const captureIdBtn = document.getElementById('capture-id-btn');
        const idCanvas = document.getElementById('id-canvas');
        const idCaptureFeedback = document.getElementById('id-capture-feedback');
        const startExamNowBtn = document.getElementById('start-exam-now-btn');
        const timerEl = document.getElementById('timer');
        const violationOverlay = document.getElementById('violation-overlay');
        const violationMessage = document.getElementById('violation-message');
        const violationCountMessage = document.getElementById('violation-count-message');
        const screenshotOverlay = document.getElementById('screenshot-overlay');
        const questionContainer = document.getElementById('question-container');
        const questionPalette = document.getElementById('question-palette');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const markReviewBtn = document.getElementById('mark-review-btn');
        const submitExamBtn = document.getElementById('submit-exam-btn');
        const confirmSubmitModal = document.getElementById('confirm-submit-modal');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
        const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
        const examHeaderInfo = document.getElementById('exam-header-info');
        const violationCounterEl = document.getElementById('violation-counter');
        // Admin Elements
        const adminLoginScreen = document.getElementById('admin-login-screen');
        const adminPanelScreen = document.getElementById('admin-panel-screen');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminQuestionsClass9 = document.getElementById('admin-questions-class9');
        const adminQuestionsClass10 = document.getElementById('admin-questions-class10');
        const adminSaveBtn = document.getElementById('admin-save-btn');
        const adminSaveFeedback = document.getElementById('admin-save-feedback');


        // --- State and Config ---
        let currentStudent = {};
        let questionBank = [];
        let mediaStream, mediaRecorder, recorderInterval, audioContext, audioSource, audioAnalyser;
        let recordedChunks = [];
        const EXAM_DURATION_SECONDS = 60 * 60; // 60 minutes
        const RECORDING_CHUNK_INTERVAL_MS = 20 * 1000;
        const PROCTOR_MEET_LINK = "https://meet.google.com/owx-mgdw-uxs";
        const MAX_VIOLATIONS = 5; // Increased to 5
        const AUDIO_THRESHOLD = 60; // Increased sensitivity slightly for ambient noise
        const SUSTAINED_NOISE_LIMIT = 2; // Requires 2 consecutive checks of loud noise
        const ADMIN_PASSWORD = "admin123"; 
        let violationCounter = 0;
        let currentQuestionIndex = 0;
        let timerInterval, monitoringInterval;

        // State flags for violation tracking to prevent repeated triggers
        let isCameraWarningActive = false;
        let isSoundWarningActive = false;
        let isTabSwitchWarningActive = false;
        let sustainedSoundCount = 0;


        // --- Default Question Banks ---
        const defaultQuestionBankClass9 = {
            subject: "Science",
            questions: [
                { id: 901, text: "Explain the process of photosynthesis in plants.", userAnswer: "", status: "not-answered" },
                { id: 902, text: "What is Newton's First Law of Motion? Provide a real-world example.", userAnswer: "", status: "not-answered" },
                { id: 903, text: "Describe the structure of a human cell with a labeled diagram.", userAnswer: "", status: "not-answered" },
                { id: 904, text: "What are the differences between acids and bases?", userAnswer: "", status: "not-answered" },
                { id: 905, text: "Explain the water cycle.", userAnswer: "", status: "not-answered" },
            ]
        };

        const defaultQuestionBankClass10 = {
            subject: "Mathematics",
            questions: [
                { id: 1001, text: "Solve the quadratic equation: x² - 5x + 6 = 0.", userAnswer: "", status: "not-answered" },
                { id: 1002, text: "Prove that the sum of angles in a triangle is 180 degrees.", userAnswer: "", status: "not-answered" },
                { id: 1003, text: "If the radius of a circle is 7cm, find its area and circumference.", userAnswer: "", status: "not-answered" },
                { id: 1004, text: "Explain the concept of probability with an example of rolling a dice.", userAnswer: "", status: "not-answered" },
                { id: 1005, text: "What is the Pythagorean theorem? Use it to solve for the hypotenuse of a right-angled triangle with sides 3cm and 4cm.", userAnswer: "", status: "not-answered" },
            ]
        };
        
        // --- Event Listeners ---
        window.addEventListener('load', handleRouting);
        window.addEventListener('hashchange', handleRouting);

        document.querySelectorAll('.student-login-btn').forEach(btn => btn.addEventListener('click', handleLogin));
        agreeCheckbox.addEventListener('change', () => { agreeBtn.disabled = !agreeCheckbox.checked; });
        agreeBtn.addEventListener('click', () => {
            guidelinesScreen.classList.add('hidden');
            permissionsScreen.classList.remove('hidden');
        });
        grantPermissionsBtn.addEventListener('click', requestPermissions);
        captureIdBtn.addEventListener('click', captureId);
        startExamNowBtn.addEventListener('click', startExam);
        document.addEventListener('visibilitychange', handleVisibilityChange);
        prevQuestionBtn.addEventListener('click', showPreviousQuestion);
        nextQuestionBtn.addEventListener('click', showNextQuestion);
        markReviewBtn.addEventListener('click', markQuestionForReview);
        submitExamBtn.addEventListener('click', () => { confirmSubmitModal.classList.remove('hidden'); });
        cancelSubmitBtn.addEventListener('click', () => { confirmSubmitModal.classList.add('hidden'); });
        confirmSubmitBtn.addEventListener('click', () => {
            confirmSubmitModal.classList.add('hidden');
            endExam("Exam submitted successfully.");
        });
        // Admin Listeners
        adminLoginBtn.addEventListener('click', handleAdminLogin);
        adminSaveBtn.addEventListener('click', handleAdminSave);

        // --- Core Functions ---
        
        function handleRouting() {
            const hash = window.location.hash;
            if (hash === '#admin') {
                loginScreen.classList.add('hidden');
                adminPanelScreen.classList.add('hidden');
                adminLoginScreen.classList.remove('hidden');
            } else {
                adminLoginScreen.classList.add('hidden');
                adminPanelScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        }

        function handleLogin(event) {
            const student = event.target.dataset.student;
            const storedBank9 = JSON.parse(localStorage.getItem('questionBankClass9'));
            const storedBank10 = JSON.parse(localStorage.getItem('questionBankClass10'));

            if (student === 'siril') {
                currentStudent = { name: 'Siril', class: '9', id: 'SIRIL09' };
                const questionData = storedBank9 || defaultQuestionBankClass9;
                questionBank = questionData.questions;
            } else {
                currentStudent = { name: 'Sam', class: '10', id: 'SAM10' };
                const questionData = storedBank10 || defaultQuestionBankClass10;
                questionBank = questionData.questions;
            }
            loginScreen.classList.add('hidden');
            guidelinesScreen.classList.remove('hidden');
        }

        async function requestPermissions() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: true });
                permissionsScreen.classList.add('hidden');
                idVerificationScreen.classList.remove('hidden');
                webcamPreview.srcObject = mediaStream;
            } catch (err) {
                permissionsError.textContent = `Error: ${err.message}. Permissions are mandatory.`;
                permissionsError.classList.remove('hidden');
            }
        }

        function captureId() {
            idCanvas.width = webcamPreview.videoWidth;
            idCanvas.height = webcamPreview.videoHeight;
            const context = idCanvas.getContext('2d');
            context.drawImage(webcamPreview, 0, 0, idCanvas.width, idCanvas.height);
            idCanvas.toBlob(blob => console.log("ID Image captured, size:", blob.size), 'image/jpeg');
            idCaptureFeedback.innerHTML = `<p class="text-green-600 font-semibold">ID Captured Successfully!</p>
                <button id="proceed-to-lobby-btn" class="mt-4 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700">Proceed to Final Step</button>`;
            document.getElementById('proceed-to-lobby-btn').addEventListener('click', showLobby);
            captureIdBtn.disabled = true;
        }

        function showLobby() {
            idVerificationScreen.classList.add('hidden');
            preExamLobbyScreen.classList.remove('hidden');

            const subject = currentStudent.class === '9' 
                ? (JSON.parse(localStorage.getItem('questionBankClass9'))?.subject || defaultQuestionBankClass9.subject)
                : (JSON.parse(localStorage.getItem('questionBankClass10'))?.subject || defaultQuestionBankClass10.subject);
            
            const meetUrl = `${PROCTOR_MEET_LINK}?examId=${subject.toUpperCase()}&cand=${currentStudent.id}`;
            window.open(meetUrl, 'ProctoringSession', 'width=800,height=600');
        }

        function startExam() {
            preExamLobbyScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            proctorFeed.srcObject = mediaStream;

            const subject = currentStudent.class === '9' 
                ? (JSON.parse(localStorage.getItem('questionBankClass9'))?.subject || defaultQuestionBankClass9.subject)
                : (JSON.parse(localStorage.getItem('questionBankClass10'))?.subject || defaultQuestionBankClass10.subject);

            examHeaderInfo.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800">Annual Examination - ${subject}</h1>
                <p class="text-gray-500">Candidate: ${currentStudent.name} (Class: ${currentStudent.class})</p>
            `;
            
            // Security Enhancements
            enterFullScreen();
            document.addEventListener('contextmenu', event => event.preventDefault());
            document.addEventListener('copy', event => event.preventDefault());
            document.addEventListener('keydown', (e) => {
                if (e.key === 'PrintScreen') {
                    e.preventDefault();
                    flashScreenshotWarning();
                }
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                }
                if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) {
                    e.preventDefault();
                }
            });


            startTimer(EXAM_DURATION_SECONDS);
            startRecording();
            startMonitoring();
            renderQuestionPalette();
            renderQuestion(currentQuestionIndex);
        }

        function renderQuestion(index) {
            const question = questionBank[index];
            questionContainer.innerHTML = `
                <h3 class="font-semibold text-lg mb-2">Question ${index + 1} of ${questionBank.length}</h3>
                <p class="text-gray-700 mb-4">${question.text}</p>
                <div class="mt-4">
                    <label for="answer-text" class="block text-sm font-medium text-gray-700 mb-2">Your Answer:</label>
                    <textarea id="answer-text" rows="10" class="w-full p-3 border border-gray-300 rounded-lg">${question.userAnswer}</textarea>
                </div>`;
            
            const textarea = document.getElementById('answer-text');
            textarea.addEventListener('input', () => {
                question.userAnswer = textarea.value;
                if (textarea.value.trim() !== '' && question.status !== 'marked-for-review') {
                    question.status = 'answered';
                } else if (textarea.value.trim() === '' && question.status !== 'marked-for-review') {
                     question.status = 'not-answered';
                }
                renderQuestionPalette();
            });

            prevQuestionBtn.disabled = index === 0;
            nextQuestionBtn.disabled = index === questionBank.length - 1;
            updatePaletteHighlight();
        }

        function renderQuestionPalette() {
            questionPalette.innerHTML = '';
            questionBank.forEach((q, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = `question-palette-btn ${q.status}`;
                button.addEventListener('click', () => {
                    currentQuestionIndex = index;
                    renderQuestion(currentQuestionIndex);
                });
                questionPalette.appendChild(button);
            });
            updatePaletteHighlight();
        }
        
        function updatePaletteHighlight() {
            Array.from(questionPalette.children).forEach((btn, index) => {
                btn.classList.toggle('current-question', index === currentQuestionIndex);
            });
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
            }
        }
        
        function showNextQuestion() {
            if (currentQuestionIndex < questionBank.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
            }
        }
        
        function markQuestionForReview() {
            questionBank[currentQuestionIndex].status = 'marked-for-review';
            renderQuestionPalette();
            if (currentQuestionIndex < questionBank.length - 1) {
                showNextQuestion();
            }
        }
        
        function startTimer(duration) {
            let timer = duration;
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (--timer < 0) {
                    endExam("Time's up!");
                }
            }, 1000);
        }

        function startRecording() { /* Unchanged */ }
        function uploadChunk() { /* Unchanged */ }

        // --- Advanced Monitoring & Security ---
        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            }
        }
        
        function flashScreenshotWarning() {
            screenshotOverlay.classList.remove('hidden');
            triggerViolation('screenshot', 'Screenshot attempt detected.');
            setTimeout(() => {
                screenshotOverlay.classList.add('hidden');
            }, 2000); // Hide after 2 seconds
        }

        function startMonitoring() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioAnalyser = audioContext.createAnalyser();
                audioSource = audioContext.createMediaStreamSource(mediaStream);
                audioSource.connect(audioAnalyser);
                audioAnalyser.fftSize = 256;
            } catch (e) { console.error("Could not set up audio monitoring:", e); }

            monitoringInterval = setInterval(() => {
                // Camera check
                const videoTrack = mediaStream.getVideoTracks()[0];
                if ((!videoTrack || videoTrack.muted || !videoTrack.enabled) && !isCameraWarningActive) {
                    triggerViolation("camera", "Camera is off or obscured.");
                    isCameraWarningActive = true;
                } else if (videoTrack && !videoTrack.muted && videoTrack.enabled && isCameraWarningActive) {
                    resolveViolation("camera");
                    isCameraWarningActive = false;
                }

                // Audio check for sustained noise
                if (audioAnalyser) {
                    const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
                    audioAnalyser.getByteFrequencyData(dataArray);
                    let average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                    
                    if (average > AUDIO_THRESHOLD) {
                        sustainedSoundCount++;
                    } else {
                        sustainedSoundCount = 0;
                        if (isSoundWarningActive) {
                           resolveViolation("sound");
                           isSoundWarningActive = false;
                        }
                    }

                    if (sustainedSoundCount >= SUSTAINED_NOISE_LIMIT && !isSoundWarningActive) {
                        triggerViolation("sound", "Loud noise or multiple voices detected.");
                        isSoundWarningActive = true;
                    }
                }
            }, 1500); // Check more frequently
        }

        function handleVisibilityChange() {
             if (document.hidden && !examScreen.classList.contains('hidden') && !isTabSwitchWarningActive) {
                triggerViolation("tab", "You have switched away from the exam tab.");
                isTabSwitchWarningActive = true;
            } else if (!document.hidden && isTabSwitchWarningActive) {
                resolveViolation("tab");
                isTabSwitchWarningActive = false;
            }
        }

        function triggerViolation(type, message) {
            if (examScreen.classList.contains('hidden')) return;
            violationCounter++;
            violationCounterEl.textContent = violationCounter;
            
            console.log('--- VIOLATION DETECTED (ADMIN LOG) ---');
            console.log({
                timestamp: new Date().toISOString(),
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                violationType: message,
                violationCount: violationCounter
            });
            
            if(type !== 'screenshot'){
                violationOverlay.dataset.violationType = type;
                violationMessage.textContent = message;
                violationCountMessage.textContent = `Violations: ${violationCounter} of ${MAX_VIOLATIONS}`;
                violationOverlay.classList.remove('hidden');
            }


            if (violationCounter >= MAX_VIOLATIONS) {
                endExam(`Disqualified due to reaching ${MAX_VIOLATIONS} violations.`);
            }
        }

        function resolveViolation(type) {
            // Only hide the overlay if it's showing the warning for the issue that was just resolved.
            if (violationOverlay.dataset.violationType === type) {
                violationOverlay.classList.add('hidden');
                violationOverlay.dataset.violationType = "";
            }
        }
        
        function endExam(reason) {
            clearInterval(timerInterval);
            clearInterval(recorderInterval);
            clearInterval(monitoringInterval);

            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            if(audioContext && audioContext.state !== 'closed') audioContext.close();

            const isDisqualified = reason.includes("Disqualified");
            let endScreenContent = isDisqualified 
                ? `<div class="text-center p-12 bg-white rounded-lg shadow-xl"><h1 class="text-3xl font-bold text-red-600">Exam Terminated</h1><p class="text-gray-600 mt-4 text-lg">${reason}</p><p class="mt-2 font-bold">Your session has been locked. Please contact the administrator.</p></div>`
                : `<div class="text-center p-12 bg-white rounded-lg shadow-xl max-w-2xl"><h1 class="text-3xl font-bold text-gray-800">Exam Over</h1><p class="text-gray-600 mt-4 text-lg">The time for the written exam has concluded.</p><div class="mt-6 p-6 bg-blue-50 border-l-4 border-blue-500 text-left"><h2 class="font-bold text-xl text-blue-800 mb-2">WhatsApp Submission Instructions</h2><p class="text-blue-700">You must submit your written answer sheet by taking clear photos and sending them to the official WhatsApp number within <strong>10 minutes</strong>.</p></div></div>`;
            
            const endScreen = document.createElement('div');
            endScreen.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4';
            endScreen.innerHTML = endScreenContent;

            document.body.innerHTML = '';
            document.body.appendChild(endScreen);

            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
        }

        // --- Admin Functions ---
        function handleAdminLogin() {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLoginScreen.classList.add('hidden');
                adminPanelScreen.classList.remove('hidden');
                loadAdminQuestions();
            } else {
                adminLoginError.classList.remove('hidden');
            }
        }

        function loadAdminQuestions() {
            const storedBank9 = JSON.parse(localStorage.getItem('questionBankClass9'));
            const storedBank10 = JSON.parse(localStorage.getItem('questionBankClass10'));

            if (storedBank9) {
                adminQuestionsClass9.value = storedBank9.questions.map(q => q.text).join('\n');
            }
            if (storedBank10) {
                adminQuestionsClass10.value = storedBank10.questions.map(q => q.text).join('\n');
            }
        }

        function handleAdminSave() {
            const questions9Text = adminQuestionsClass9.value.trim().split('\n').filter(Boolean);
            const questions10Text = adminQuestionsClass10.value.trim().split('\n').filter(Boolean);

            const newBank9 = {
                subject: "Science",
                questions: questions9Text.map((text, i) => ({ id: 901 + i, text, userAnswer: "", status: "not-answered" }))
            };
             const newBank10 = {
                subject: "Mathematics",
                questions: questions10Text.map((text, i) => ({ id: 1001 + i, text, userAnswer: "", status: "not-answered" }))
            };

            localStorage.setItem('questionBankClass9', JSON.stringify(newBank9));
            localStorage.setItem('questionBankClass10', JSON.stringify(newBank10));

            adminSaveFeedback.textContent = 'Questions saved successfully!';
            setTimeout(() => { adminSaveFeedback.textContent = ''; }, 3000);
        }

    </script>

</body>
</html>
